<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BEMO Mobile</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Main app container */
        #app-container {
            max-width: 480px;
            margin: auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: #f1f5f9;
            position: relative;
        }

        /* Screen transition styles */
        .app-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f1f5f9;
            display: flex;
            flex-direction: column;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
            z-index: 1;
        }
        .app-screen.active {
            transform: translateX(0);
            z-index: 10;
        }
        .app-screen.exiting {
            transform: translateX(-30%);
            z-index: 5;
        }

        /* Map bottom sheet styles */
        #map-bottom-sheet {
            transition: transform 0.3s ease-in-out;
            touch-action: none;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.2s;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        #toast-notification {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translate(-50%, 100px);
            background-color: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 9999px;
            z-index: 10000;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 0;
            font-size: 0.875rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        #toast-notification.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        /* Disabled button state */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .map-pin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            font-size: 2.5rem;
            color: #ef4444; /* red-500 */
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-800">

<div id="app-container">

    <main class="relative flex-1 overflow-hidden">
        <section id="home-screen" class="app-screen">
            <header class="p-4 flex justify-between items-center bg-white shadow-sm flex-shrink-0">
                <div>
                    <p class="text-sm text-slate-500">Selamat Datang,</p>
                    <h1 class="text-xl font-bold text-slate-800">Pengguna BEMO</h1>
                </div>
                <img src="https://placehold.co/48x48/E2E8F0/475569?text=P" alt="Avatar Pengguna" class="w-12 h-12 rounded-full">
            </header>

            <main class="flex-grow p-4 overflow-y-auto">
                <div class="mt-4">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">Pilih Layanan</h2>
                    <div id="service-grid" class="grid grid-cols-3 gap-4 text-center">
                        </div>
                </div>
                
                <div class="mt-8">
                     <h2 class="text-lg font-semibold text-slate-700 mb-4">Perjalanan Khusus</h2>
                     <a href="#" id="charter-entry-btn" role="button" aria-label="Sewa Kendaraan untuk perjalanan khusus" class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between hover:bg-slate-50 transition-colors">
                         <div>
                             <h3 class="font-bold text-slate-800">Sewa Kendaraan</h3>
                             <p class="text-sm text-slate-500">Rencanakan perjalanan grup Anda.</p>
                         </div>
                         <i class="fas fa-chevron-right text-slate-400" aria-hidden="true"></i>
                     </a>
                </div>
            </main>
        </section>

        <section id="map-screen" class="app-screen">
            <header class="p-4 flex items-center bg-white shadow-sm z-20 flex-shrink-0">
                <button class="back-btn text-slate-600 mr-4" data-target="home-screen" aria-label="Kembali ke beranda"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 id="map-title" class="text-xl font-bold text-slate-800">Peta Layanan</h1>
            </header>
            <div class="flex-grow relative">
                <div id="map-view" class="h-full w-full z-10"></div>
                <div id="map-bottom-sheet" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-20 flex flex-col" style="transform: translateY(calc(100% - 220px)); max-height: 85vh;">
                     <div id="sheet-handle" class="w-10 h-1 bg-slate-300 rounded-full mx-auto my-3 cursor-grab flex-shrink-0" aria-label="Geser untuk membuka detail"></div>
                     <div class="px-4 pb-4 overflow-y-auto">
                         <div class="flex items-center mb-4">
                             <i id="sheet-icon" class="fas fa-bus text-2xl text-blue-500 mr-3" aria-hidden="true"></i>
                             <h2 id="sheet-title" class="text-lg font-bold text-slate-800">Detail Rute</h2>
                         </div>
                         <div>
                             <label for="route-select" class="text-sm font-medium text-slate-600">Pilih Rute Anda</label>
                             <select id="route-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                         </div>
                         <div class="mt-4 text-sm text-slate-600">
                             <p>Estimasi kendaraan terdekat: <span id="nearest-vehicle" class="font-semibold text-slate-800">5 menit</span></p>
                             <p id="fare-info">Tarif: <span id="route-fare" class="font-semibold text-slate-800">Rp 5.000</span></p>
                         </div>
                         <button id="order-ticket-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-blue-700 transition-colors">Pesan Tiket</button>
                     </div>
                </div>
            </div>
        </section>

        <section id="payment-screen" class="app-screen bg-white">
            <header class="p-4 flex items-center bg-white shadow-sm flex-shrink-0">
                <button class="back-btn text-slate-600 mr-4" data-target="map-screen" aria-label="Kembali ke peta"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 id="payment-screen-title" class="text-xl font-bold text-slate-800">Pembayaran</h1>
            </header>
            <main class="flex-grow flex flex-col justify-center items-center p-6 text-center">
                <p class="text-slate-600">Pindai Kode QRIS ini untuk membayar</p>
                <div id="payment-qrcode" class="my-6 p-4 border rounded-lg bg-white"></div>
                <div class="text-lg">
                    <p class="text-slate-500">Total Pembayaran</p>
                    <p id="payment-amount" class="text-3xl font-bold text-blue-600">Rp 0</p>
                </div>
                <p class="text-xs text-slate-400 mt-4">Pesanan akan batal dalam <span id="payment-timer">5:00</span></p>
                <button id="confirm-payment-btn" class="w-full max-w-sm bg-green-500 text-white font-bold py-3 px-4 rounded-lg mt-8 hover:bg-green-600 transition-colors">Saya Sudah Bayar</button>
            </main>
        </section>

        <section id="ticket-screen" class="app-screen">
            <header class="p-4 flex items-center justify-between bg-white shadow-sm flex-shrink-0">
                <h1 id="ticket-screen-title" class="text-xl font-bold text-slate-800">E-Tiket Anda</h1>
                <button class="done-btn text-blue-600 font-semibold" aria-label="Selesai dan kembali ke beranda">Selesai</button>
            </header>
            <main class="flex-grow flex flex-col items-center p-6 space-y-6 overflow-y-auto">
                <div id="ticket-details" class="bg-white w-full max-w-sm rounded-xl shadow-lg">
                    </div>
                <div id="charter-simulation-controls" class="w-full max-w-sm"></div>
                
                <button id="download-ticket-btn" class="w-full max-w-sm bg-slate-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-slate-800">
                    <i class="fas fa-download" aria-hidden="true"></i>
                    <span>Unduh Tiket</span>
                </button>
            </main>
        </section>
        
        <section id="history-screen" class="app-screen">
            <header class="p-4 flex items-center bg-white shadow-sm flex-shrink-0">
                 <button class="back-btn text-slate-600 mr-4" data-target="home-screen" aria-label="Kembali ke beranda"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 class="text-xl font-bold text-slate-800">Riwayat Pesanan</h1>
            </header>
            <main id="history-list-container" class="flex-grow p-4 overflow-y-auto space-y-3">
                </main>
        </section>

        <section id="charter-form-screen" class="app-screen">
            <header class="p-4 flex items-center bg-white shadow-sm flex-shrink-0">
                <button class="back-btn text-slate-600 mr-4" data-target="home-screen" aria-label="Kembali ke beranda"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 class="text-xl font-bold text-slate-800">Sewa Kendaraan</h1>
            </header>
            <main class="flex-grow p-4 overflow-y-auto space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div>
                        <label for="charter-service-select" class="block text-sm font-medium text-slate-700">Jenis Kendaraan</label>
                        <select id="charter-service-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div class="mt-4">
                        <label for="charter-pax" class="block text-sm font-medium text-slate-700">Jumlah Orang</label>
                        <input type="number" id="charter-pax" min="1" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: 15">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="charter-date" class="block text-sm font-medium text-slate-700">Tanggal</label>
                            <input type="date" id="charter-date" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="charter-time" class="block text-sm font-medium text-slate-700">Jam</label>
                            <input type="time" id="charter-time" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-slate-700">Lokasi Jemput</label>
                        <button id="select-pickup-loc-btn" class="mt-1 text-left w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-500 truncate">
                            Pilih di peta...
                        </button>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-slate-700">Lokasi Antar</label>
                        <button id="select-dropoff-loc-btn" class="mt-1 text-left w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-white text-slate-500 truncate">
                            Pilih di peta...
                        </button>
                    </div>
                </div>
                <button id="request-charter-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-4 hover:bg-blue-700">Ajukan Permintaan Charter</button>
            </main>
        </section>

        <section id="charter-map-screen" class="app-screen">
            <header class="p-4 flex items-center bg-white shadow-sm z-20 flex-shrink-0">
                <button id="charter-map-back-btn" class="text-slate-600 mr-4"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 id="charter-map-title" class="text-xl font-bold text-slate-800">Pilih Lokasi</h1>
            </header>
            <div class="flex-grow relative">
                <div id="charter-map-view" class="h-full w-full z-10"></div>
                <div class="map-pin z-20">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="absolute bottom-0 left-0 right-0 p-4 z-20">
                    <button id="confirm-charter-loc-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Konfirmasi Lokasi Ini</button>
                </div>
            </div>
        </section>

    </main>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>
    <div id="toast-notification"></div>

    <footer class="grid grid-cols-3 gap-4 p-2 bg-white shadow-[0_-5px_15px_-3px_rgba(0,0,0,0.1)] z-30 flex-shrink-0">
        <a href="#" class="nav-item text-center p-2 rounded-lg" data-target="home-screen" role="button" aria-label="Navigasi Beranda">
            <i class="fas fa-home text-xl"></i>
            <span class="block text-xs">Beranda</span>
        </a>
        <a href="#" class="nav-item text-center p-2 rounded-lg" data-target="history-screen" role="button" aria-label="Navigasi Riwayat">
            <i class="fas fa-history text-xl"></i>
            <span class="block text-xs">Riwayat</span>
        </a>
        <a href="#" class="nav-item text-center p-2 rounded-lg" data-target="#" role="button" aria-label="Navigasi Profil">
            <i class="fas fa-user text-xl"></i>
            <span class="block text-xs">Profil</span>
        </a>
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- State Management ---
    const appState = {
        currentScreen: null,
        previousScreen: null,
        currentService: null,
        currentOrderForPayment: null, // Digunakan untuk membedakan pembayaran reguler vs charter
        map: null,
        charterMap: null,
        charterOrder: {},
        charterLocationType: null, // 'pickup' or 'dropoff'
    };

    // --- Data Tiruan ---
    const serviceData = {
        'TMB': { name: 'TMB', color: 'blue-500', icon: 'fa-bus', fare: 5000, routes: [{ name: 'KBP - Cicaheum', id: 'TMB01'}, { name: 'Cibiru - Elang', id: 'TMB02'}], vehicles: [{ lat: -6.9038, lng: 107.6186 }, { lat: -6.9250, lng: 107.6350 }]},
        'Bus Sekolah': { name: 'Bus Sekolah', color: 'green-500', icon: 'fa-school', fare: 0, routes: [{ name: 'Rute Dago', id: 'BS01'}], vehicles: [{ lat: -6.8700, lng: 107.5941 }]},
        'Bandros': { name: 'Bandros', color: 'red-500', icon: 'fa-bus-alt', fare: 20000, routes: [{ name: 'Tur Sejarah', id: 'BDR01'}], vehicles: [{ lat: -6.9150, lng: 107.6191 }]},
        'Angkot': { name: 'Angkot', color: 'yellow-500', icon: 'fa-car-side', fare: 4000, routes: [{ name: 'Cicaheum - Ledeng', id: 'ANG01'}], vehicles: [{ lat: -6.8915, lng: 107.6107 }]},
        'Boseh': { name: 'Boseh', color: 'purple-500', icon: 'fa-bicycle', external: true }
    };
    
    let historyData = [
        { id: 'charter001-completed', type: 'charter', serviceName: 'Bandros', date: '14 Agu 2025', fare: 750000, status: 'Selesai', pickup: 'Stasiun Bandung', dropoff: 'Lembang Park & Zoo', driver: 'Asep Sunandar', vehicle: 'Bandros D 9012 JKW'},
        { id: 'hist001', type: 'reguler', serviceName: 'TMB', routeName: 'KBP - Cicaheum', date: '15 Agu 2025', fare: 5000, status: 'Menunggu Keberangkatan' },
        { id: 'hist002', type: 'reguler', serviceName: 'Bandros', routeName: 'Tur Sejarah', date: '12 Agu 2025', fare: 20000, status: 'Selesai' },
        { id: 'hist003', type: 'reguler', serviceName: 'Angkot', routeName: 'Cicaheum - Ledeng', date: '11 Agu 2025', fare: 4000, status: 'Selesai' },
        { id: 'hist004', type: 'reguler', serviceName: 'TMB', routeName: 'Cibiru - Elang', date: '10 Agu 2025', fare: 5000, status: 'Dibatalkan' },
    ];

    // --- DOM Elements ---
    const dom = {
        appContainer: document.getElementById('app-container'),
        screens: document.querySelectorAll('.app-screen'),
        loadingOverlay: document.getElementById('loading-overlay'),
        toast: document.getElementById('toast-notification'),
        serviceGrid: document.getElementById('service-grid'),
        historyListContainer: document.getElementById('history-list-container'),
        mapView: document.getElementById('map-view'),
        routeSelect: document.getElementById('route-select'),
        paymentScreen: document.getElementById('payment-screen'),
        // Charter Form
        charterServiceSelect: document.getElementById('charter-service-select'),
        charterPax: document.getElementById('charter-pax'),
        charterDate: document.getElementById('charter-date'),
        charterTime: document.getElementById('charter-time'),
        selectPickupBtn: document.getElementById('select-pickup-loc-btn'),
        selectDropoffBtn: document.getElementById('select-dropoff-loc-btn'),
        requestCharterBtn: document.getElementById('request-charter-btn'),
        // Charter Map
        charterMapView: document.getElementById('charter-map-view'),
        charterMapTitle: document.getElementById('charter-map-title'),
        charterMapBackBtn: document.getElementById('charter-map-back-btn'),
        confirmCharterLocBtn: document.getElementById('confirm-charter-loc-btn'),
        // Ticket Screen
        ticketDetails: document.getElementById('ticket-details'),
        charterSimControls: document.getElementById('charter-simulation-controls'),
    };
    
    // --- Helper Functions ---
    const showLoading = (show) => dom.loadingOverlay.classList.toggle('hidden', !show);
    const showToast = (message, duration = 3000) => {
        dom.toast.textContent = message;
        dom.toast.classList.add('show');
        setTimeout(() => dom.toast.classList.remove('show'), duration);
    };
    const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    const delay = (ms) => new Promise(res => setTimeout(res, ms));

    // --- Navigation Logic ---
    const navigateTo = (screenId, data = {}) => {
        const nextScreenEl = document.getElementById(screenId);
        if (!nextScreenEl || screenId === appState.currentScreen) {
             if (typeof screenInitializers[screenId] === 'function') {
                screenInitializers[screenId](data);
            }
            return;
        };
        
        const currentScreenEl = appState.currentScreen ? document.getElementById(appState.currentScreen) : null;

        if (currentScreenEl) {
            currentScreenEl.classList.add('exiting');
        }
        
        nextScreenEl.classList.remove('exiting');
        nextScreenEl.classList.add('active');

        setTimeout(() => {
            dom.screens.forEach(s => s.id !== screenId && s.classList.remove('active', 'exiting'));
        }, 400);

        appState.previousScreen = appState.currentScreen;
        appState.currentScreen = screenId;
        
        if (typeof screenInitializers[screenId] === 'function') {
            screenInitializers[screenId](data);
        }
        updateBottomNav(screenId);
    };
    
    const updateBottomNav = (activeScreen) => {
        document.querySelectorAll('.nav-item').forEach(nav => {
            const target = nav.dataset.target;
            const isTargetActive = target === activeScreen || (activeScreen.includes('ticket') && target === 'history-screen');
            nav.classList.toggle('text-blue-600', isTargetActive);
            nav.classList.toggle('text-slate-500', !isTargetActive);
            nav.querySelector('span').classList.toggle('font-bold', isTargetActive);
            nav.querySelector('span').classList.toggle('font-medium', !isTargetActive);
        });
    };

    // --- Screen Initializers ---
    const screenInitializers = {
        'home-screen': () => {
            renderHomeServices();
        },
        'history-screen': () => {
            renderHistoryList();
        },
        'map-screen': ({ serviceName }) => {
            const service = serviceData[serviceName];
            if (!service) return navigateTo('home-screen');
            appState.currentService = service;
            dom.paymentScreen.querySelector('.back-btn').dataset.target = 'map-screen';

            document.getElementById('map-title').innerText = `Peta ${service.name}`;
            const sheetIcon = document.getElementById('sheet-icon');
            sheetIcon.className = `fas ${service.icon} text-2xl text-${service.color} mr-3`;
            document.getElementById('sheet-title').innerText = `Rute ${service.name}`;
            
            dom.routeSelect.innerHTML = service.routes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            const isFree = service.fare === 0;
            document.getElementById('fare-info').style.display = isFree ? 'none' : 'block';
            document.getElementById('order-ticket-btn').style.display = isFree ? 'none' : 'block';
            document.getElementById('route-fare').innerText = formatCurrency(service.fare);
            
            initializeMap();
        },
        'payment-screen': (data = {}) => {
             const isCharterPayment = !!appState.currentOrderForPayment;
             const fare = isCharterPayment ? appState.currentOrderForPayment.fare : appState.currentService.fare;
             
             document.getElementById('payment-amount').innerText = formatCurrency(fare);
             const qrContainer = document.getElementById('payment-qrcode');
             qrContainer.innerHTML = '';
             new QRCode(qrContainer, { text: `BEMO-PAY;${Date.now()};${fare}`, width: 200, height: 200 });

             // Set back button target correctly
             const backBtn = dom.paymentScreen.querySelector('.back-btn');
             backBtn.dataset.target = isCharterPayment ? 'history-screen' : 'map-screen';
             document.getElementById('payment-screen-title').textContent = isCharterPayment ? 'Pembayaran Charter' : 'Pembayaran';
        },
        'ticket-screen': async (data) => {
            dom.ticketDetails.innerHTML = '';
            dom.charterSimControls.innerHTML = '';
            showLoading(true);
            await delay(500);

            const { id, routeName, fare, serviceName, date, type, pickup, dropoff, driver, vehicle, status } = data;
            const displayDate = date || new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric'});
            const isCharter = type === 'charter';
            
            document.getElementById('ticket-screen-title').textContent = isCharter ? 'Tiket Charter' : 'E-Tiket Anda';

            const ticketHTML = `
                <div class="p-6">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-blue-600">${isCharter ? 'TIKET CHARTER' : `TIKET ${serviceName.toUpperCase()}`}</h2>
                        <p class="text-sm text-slate-500">Bandung Easy Mobility</p>
                    </div>
                    <div id="ticket-qrcode-container" class="mb-4 flex justify-center p-2 border rounded-md bg-white"></div>
                    <div class="border-t border-dashed my-4"></div>
                    <div class="text-sm space-y-2">
                        <div class="flex justify-between"><span class="text-slate-500">Nama:</span><span class="font-semibold text-slate-800">Pengguna BEMO</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">${isCharter ? 'Layanan' : 'Rute'}:</span><span class="font-semibold text-slate-800 text-right">${isCharter ? serviceName : routeName}</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Tanggal:</span><span class="font-semibold text-slate-800">${displayDate}</span></div>
                        ${isCharter ? `
                        <div class="flex justify-between text-right"><span class="text-slate-500">Dari:</span><span class="font-semibold text-slate-800">${pickup}</span></div>
                        <div class="flex justify-between text-right"><span class="text-slate-500">Ke:</span><span class="font-semibold text-slate-800">${dropoff}</span></div>
                        <div class="border-t border-dashed my-4"></div>
                        <div class="flex justify-between"><span class="text-slate-500">Pengemudi:</span><span class="font-semibold text-slate-800">${driver}</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Kendaraan:</span><span class="font-semibold text-slate-800">${vehicle}</span></div>
                        ` : ''}
                        <div class="flex justify-between"><span class="text-slate-500">Harga:</span><span class="font-semibold text-slate-800">${formatCurrency(fare)}</span></div>
                    </div>
                    <div class="border-t border-dashed my-4"></div>
                    <p class="text-xs text-slate-400 text-center">Tunjukkan kode QR ini kepada petugas.</p>
                </div>
            `;
            dom.ticketDetails.innerHTML = ticketHTML;
            
            // Generate ticket QR code
            new QRCode(document.getElementById('ticket-qrcode-container'), {
                text: `BEMO-TICKET;${id};${routeName || serviceName};${fare}`,
                width: 220, height: 220
            });
            
            // Add charter simulation controls
            if (isCharter) {
                 renderCharterSimulationControls(data);
            }

            showLoading(false);
        },
        'charter-form-screen': (data) => {
            if (dom.charterServiceSelect.options.length === 0) {
                 dom.charterServiceSelect.innerHTML = Object.values(serviceData)
                     .filter(s => !s.external)
                     .map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
            if (data.isNew) appState.charterOrder = {};
            dom.charterServiceSelect.value = appState.charterOrder.serviceName || Object.values(serviceData).find(s => !s.external).name;
            dom.charterPax.value = appState.charterOrder.pax || '';
            dom.charterDate.value = appState.charterOrder.date || '';
            dom.charterTime.value = appState.charterOrder.time || '';
            dom.selectPickupBtn.textContent = appState.charterOrder.pickup || 'Pilih di peta...';
            dom.selectDropoffBtn.textContent = appState.charterOrder.dropoff || 'Pilih di peta...';
        },
        'charter-map-screen': ({type}) => {
            appState.charterLocationType = type;
            dom.charterMapTitle.textContent = type === 'pickup' ? 'Pilih Lokasi Jemput' : 'Pilih Lokasi Antar';
            initializeCharterMap();
        }
    };

    // --- Dynamic UI Rendering ---
    const renderHomeServices = () => {
        dom.serviceGrid.innerHTML = '';
        for (const key in serviceData) {
            const service = serviceData[key];
            const item = document.createElement('a');
            item.href = '#';
            item.className = `service-item bg-white p-3 rounded-xl shadow-sm hover:bg-slate-50 transition-colors flex flex-col items-center justify-center`;
            item.dataset.service = key;
            item.setAttribute('role', 'button');
            item.setAttribute('aria-label', `Pilih layanan ${service.name}`);
            item.innerHTML = `
                <i class="fas ${service.icon} text-3xl text-${service.color}"></i>
                <span class="block mt-2 text-sm font-semibold text-slate-700">${service.name}</span>
            `;
            dom.serviceGrid.appendChild(item);
        }
    };
    
    const renderHistoryList = () => {
        dom.historyListContainer.innerHTML = '';
        if (historyData.length === 0) {
            dom.historyListContainer.innerHTML = `<p class="text-center text-slate-500 mt-8">Belum ada riwayat pesanan.</p>`;
            return;
        }
        
        const statusStyles = {
            'Selesai': { text: 'text-green-700', bg: 'bg-green-100' },
            'Menunggu Keberangkatan': { text: 'text-sky-700', bg: 'bg-sky-100' },
            'Dikonfirmasi': { text: 'text-blue-700', bg: 'bg-blue-100' },
            'Menunggu Konfirmasi': { text: 'text-amber-700', bg: 'bg-amber-100' },
            'Menunggu Pembayaran': { text: 'text-orange-700', bg: 'bg-orange-100' },
            'Driver Menuju Lokasi': { text: 'text-indigo-700', bg: 'bg-indigo-100' },
            'Dalam Perjalanan': { text: 'text-purple-700', bg: 'bg-purple-100' },
            'Dibatalkan': { text: 'text-red-700', bg: 'bg-red-100' },
            'Ditolak': { text: 'text-red-700', bg: 'bg-red-100' },
        };

        historyData.forEach(item => {
            const service = serviceData[item.serviceName];
            if (!service) return;
            const style = statusStyles[item.status] || { text: 'text-slate-700', bg: 'bg-slate-100' };
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-sm';
            
            let buttonHTML = '';
            switch (item.status) {
                case 'Menunggu Pembayaran':
                    buttonHTML = `<button data-history-id="${item.id}" class="pay-charter-btn mt-3 w-full text-center px-4 py-2 bg-orange-500 text-white text-sm font-semibold rounded-lg hover:bg-orange-600">Bayar Sekarang</button>`;
                    break;
                case 'Menunggu Keberangkatan':
                case 'Dikonfirmasi':
                case 'Driver Menuju Lokasi':
                case 'Dalam Perjalanan':
                    buttonHTML = `<button data-history-id="${item.id}" class="view-ticket-btn mt-3 w-full text-center px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-lg hover:bg-blue-600">Lihat Tiket</button>`;
                    break;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center text-sm text-slate-500">
                           <i class="fas ${service.icon} text-${service.color} mr-2"></i>
                           <span>${item.serviceName} ${item.type === 'charter' ? '(Charter)' : ''} &bull; ${item.date}</span>
                        </div>
                        <p class="font-bold text-slate-800 mt-1">${item.routeName || `Tujuan: ${item.dropoff}`}</p>
                        <p class="text-sm text-slate-600">${formatCurrency(item.fare)}</p>
                    </div>
                    <div class="text-xs font-semibold px-2 py-1 rounded-full ${style.bg} ${style.text} whitespace-nowrap">
                        ${item.status}
                    </div>
                </div>
                <div class="charter-details mt-2 text-xs text-slate-500">
                    ${(item.type === 'charter' && item.driver && item.driver !== 'Menunggu Penugasan') ? `<p>Driver: <strong>${item.driver}</strong> (${item.vehicle})</p>` : ''}
                </div>
                ${buttonHTML}
            `;
            dom.historyListContainer.appendChild(card);
        });
    };
    
    const renderCharterSimulationControls = (data) => {
        dom.charterSimControls.innerHTML = '';
        let content = '';
        const statusTextClass = "text-center p-3 mb-2 rounded-lg text-sm font-medium";
        
        switch (data.status) {
            case 'Dikonfirmasi':
                content = `<div class="${statusTextClass} bg-blue-100 text-blue-800">Driver telah ditugaskan. Menunggu penjemputan sesuai jadwal.</div>`;
                break;
            case 'Driver Menuju Lokasi':
                content = `
                    <div class="${statusTextClass} bg-indigo-100 text-indigo-800">Driver sedang menuju lokasi penjemputan.</div>
                    <button id="simulate-scan-btn" data-id="${data.id}" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">[Simulasi] Driver Scan QR Penjemputan</button>
                `;
                break;
            case 'Dalam Perjalanan':
                 content = `
                    <div class="${statusTextClass} bg-purple-100 text-purple-800">Anda sedang dalam perjalanan menuju tujuan.</div>
                    <button id="simulate-finish-btn" data-id="${data.id}" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">[Simulasi] Driver Selesaikan Perjalanan</button>
                `;
                break;
            case 'Selesai':
                content = `<div class="${statusTextClass} bg-green-100 text-green-800">Perjalanan telah selesai. Terima kasih!</div>`;
                break;
        }
        dom.charterSimControls.innerHTML = content;
    };


    // --- Map & Geolocation ---
    const initializeMap = () => {
        setTimeout(() => {
            if (appState.map) appState.map.remove();
            
            appState.map = L.map('map-view', { zoomControl: false }).setView([-6.9175, 107.6191], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(appState.map);

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLatLng = [position.coords.latitude, position.coords.longitude];
                    L.marker(userLatLng).addTo(appState.map).bindPopup('Lokasi Anda').openPopup();
                    appState.map.setView(userLatLng, 14);
                }, 
                () => showToast("Gagal mendapatkan lokasi Anda.")
            );
            
            const service = appState.currentService;
            const vehicleIcon = L.divIcon({
                className: 'vehicle-div-icon',
                html: `<div class="w-8 h-8 rounded-full flex items-center justify-center bg-${service.color} shadow-lg border-2 border-white"><i class="fas ${service.icon} text-white"></i></div>`,
                iconSize: [32, 32], iconAnchor: [16,16]
            });
            
            service.vehicles.forEach(v => L.marker([v.lat, v.lng], { icon: vehicleIcon }).addTo(appState.map));
            appState.map.invalidateSize();
        }, 100);
    };

    const initializeCharterMap = () => {
        setTimeout(() => {
            if (appState.charterMap) appState.charterMap.remove();
            
            appState.charterMap = L.map('charter-map-view', { zoomControl: false }).setView([-6.9175, 107.6191], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(appState.charterMap);

            navigator.geolocation.getCurrentPosition(
                (position) => appState.charterMap.setView([position.coords.latitude, position.coords.longitude], 15)
            );
            appState.charterMap.invalidateSize();
        }, 100);
    };
    
    // --- Simpan state form charter sebelum pindah layar ---
    const saveCharterFormState = () => {
        appState.charterOrder.serviceName = dom.charterServiceSelect.value;
        appState.charterOrder.pax = dom.charterPax.value;
        appState.charterOrder.date = dom.charterDate.value;
        appState.charterOrder.time = dom.charterTime.value;
    };


    // --- Event Listeners Setup ---
    const setupEventListeners = () => {
        dom.appContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);

            const serviceItem = closest('.service-item');
            const backBtn = closest('.back-btn');
            const navItem = closest('.nav-item');
            const doneBtn = closest('.done-btn');
            const viewTicketBtn = closest('.view-ticket-btn');
            const payCharterBtn = closest('.pay-charter-btn');

            if (serviceItem) {
                e.preventDefault();
                const serviceName = serviceItem.dataset.service;
                if (serviceData[serviceName].external) {
                    showToast("Layanan Boseh memerlukan aplikasi terpisah.");
                    return;
                }
                navigateTo('map-screen', { serviceName });
            }
            if (backBtn) navigateTo(backBtn.dataset.target);
            if (navItem && navItem.dataset.target !== '#') navigateTo(navItem.dataset.target);
            if (doneBtn) navigateTo('home-screen');
            if (viewTicketBtn) {
                const historyItem = historyData.find(item => item.id === viewTicketBtn.dataset.historyId);
                if (historyItem) navigateTo('ticket-screen', historyItem);
            }
            if (payCharterBtn) {
                const orderId = payCharterBtn.dataset.historyId;
                const order = historyData.find(item => item.id === orderId);
                if (order) {
                    appState.currentOrderForPayment = order;
                    navigateTo('payment-screen');
                }
            }


            // Specific Buttons
            switch(target.id) {
                case 'order-ticket-btn':
                    appState.currentOrderForPayment = null; // Pastikan ini pembayaran reguler
                    navigateTo('payment-screen');
                    break;
                case 'charter-entry-btn':
                    e.preventDefault();
                    navigateTo('charter-form-screen', { isNew: true });
                    break;
                case 'select-pickup-loc-btn':
                    saveCharterFormState();
                    navigateTo('charter-map-screen', { type: 'pickup' });
                    break;
                case 'select-dropoff-loc-btn':
                    saveCharterFormState();
                    navigateTo('charter-map-screen', { type: 'dropoff' });
                    break;
                case 'charter-map-back-btn':
                    navigateTo('charter-form-screen');
                    break;
                case 'confirm-charter-loc-btn':
                    {
                        const center = appState.charterMap.getCenter();
                        const locationName = `Lokasi (${center.lat.toFixed(4)}, ${center.lng.toFixed(4)})`;
                        if (appState.charterLocationType === 'pickup') {
                            appState.charterOrder.pickup = locationName;
                        } else {
                            appState.charterOrder.dropoff = locationName;
                        }
                        navigateTo('charter-form-screen');
                    }
                    break;
                case 'request-charter-btn':
                    {
                        saveCharterFormState(); // Save latest state before submitting
                        const { serviceName, pax, date, time, pickup, dropoff } = appState.charterOrder;
                        if (!serviceName || !pax || !date || !time || !pickup || !dropoff) {
                            showToast("Harap lengkapi semua data charter.");
                            return;
                        }
                        
                        target.disabled = true;
                        showLoading(true);
                        
                        const newCharterId = `charter${Date.now()}`;
                        const newCharter = {
                            id: newCharterId,
                            type: 'charter',
                            ...appState.charterOrder,
                            date: new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }),
                            status: 'Menunggu Konfirmasi',
                            fare: 0, // Harga akan ditentukan oleh admin
                            driver: "Menunggu Penugasan",
                            vehicle: "Menunggu Penugasan",
                        };
                        historyData.unshift(newCharter);
                        
                        showToast("Permintaan charter diajukan...");
                        navigateTo('history-screen');
                        
                        // --- Simulasi Admin Konfirmasi Harga ---
                        setTimeout(() => {
                             const order = historyData.find(c => c.id === newCharterId);
                             if(order) {
                                order.status = 'Menunggu Pembayaran';
                                order.fare = (Math.floor(Math.random() * (150 - 50 + 1)) + 50) * 10000; // Harga acak antara 500rb - 1.5jt
                                if(appState.currentScreen === 'history-screen') {
                                    renderHistoryList();
                                }
                                showToast("Admin mengonfirmasi harga. Silakan bayar.");
                             }
                        }, 2000);

                        showLoading(false);
                        target.disabled = false;
                    }
                    break;
                case 'download-ticket-btn':
                    {
                        if (!dom.ticketDetails) return;
                        showLoading(true);
                        await delay(200);
                        html2canvas(dom.ticketDetails, { scale: 2, backgroundColor: null }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `e-tiket-bemo-${Date.now()}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                            showLoading(false);
                            showToast('Tiket berhasil diunduh.');
                        });
                    }
                    break;
                case 'confirm-payment-btn':
                    {
                        target.disabled = true;
                        target.innerHTML = `<span class="spinner !w-5 !h-5 !border-2"></span><span class="ml-2">Memproses...</span>`;
                        
                        await delay(1500); 

                        // Cek apakah ini pembayaran charter atau reguler
                        if (appState.currentOrderForPayment) {
                            // Ini adalah pembayaran charter
                            const order = historyData.find(item => item.id === appState.currentOrderForPayment.id);
                            if (order) {
                                showToast("Pembayaran charter berhasil!", 2000);
                                order.status = 'Dikonfirmasi';

                                // --- Simulasi Admin Memberi Info Driver ---
                                setTimeout(() => {
                                    order.driver = "Ujang Supriadi";
                                    order.vehicle = `Hiace D ${Math.floor(1000 + Math.random() * 9000)} UJP`;
                                    showToast("Info driver & kendaraan diterima.", 2000);
                                     if(appState.currentScreen === 'history-screen') renderHistoryList();

                                    // --- Simulasi Driver Menjemput (2 menit -> diubah jadi 10 detik untuk demo) ---
                                    setTimeout(() => {
                                        if (order.status === 'Dikonfirmasi') { // Hanya jalan jika status belum berubah
                                            order.status = 'Driver Menuju Lokasi';
                                            showToast("Driver sedang dalam perjalanan menjemput Anda!", 4000);
                                            if(appState.currentScreen === 'history-screen') renderHistoryList();
                                            if(appState.currentScreen === 'ticket-screen') navigateTo('ticket-screen', order); // Refresh ticket screen if open
                                        }
                                    }, 10000); // 120000 ms = 2 menit
                                }, 2000);
                            }
                            navigateTo('history-screen');
                            appState.currentOrderForPayment = null; // Reset
                        } else {
                            // Ini pembayaran reguler
                            const selectedRouteEl = dom.routeSelect;
                            const routeName = selectedRouteEl.options[selectedRouteEl.selectedIndex].text;
                            const newHistoryItem = {
                                id: `hist${Date.now()}`,
                                type: 'reguler',
                                serviceName: appState.currentService.name,
                                routeName: routeName,
                                date: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }),
                                fare: appState.currentService.fare,
                                status: 'Menunggu Keberangkatan'
                            };
                            historyData.unshift(newHistoryItem);
                            navigateTo('ticket-screen', newHistoryItem);
                        }
                        
                        target.disabled = false;
                        target.textContent = 'Saya Sudah Bayar';
                    }
                    break;
                case 'simulate-scan-btn': {
                    const orderId = target.dataset.id;
                    const order = historyData.find(item => item.id === orderId);
                    if (order) {
                        order.status = 'Dalam Perjalanan';
                        showToast("Penjemputan berhasil. Selamat menikmati perjalanan!");
                        navigateTo('ticket-screen', order); // Refresh ticket view
                        if (appState.previousScreen === 'history-screen') {
                           renderHistoryList();
                        }
                    }
                    break;
                }
                case 'simulate-finish-btn': {
                    const orderId = target.dataset.id;
                    const order = historyData.find(item => item.id === orderId);
                    if (order) {
                        order.status = 'Selesai';
                        showToast("Perjalanan telah selesai. Terima kasih!");
                        navigateTo('ticket-screen', order); // Refresh ticket view
                        setTimeout(() => navigateTo('history-screen'), 2000);
                    }
                    break;
                }
            }
        });
    };

    // --- Main Initializer ---
    const init = () => {
        showLoading(true);
        setupEventListeners();
        navigateTo('home-screen');
        showLoading(false);
    };

    // --- Run App ---
    init();
});
</script>

</body>
</html>